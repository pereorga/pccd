<VirtualHost *:80>
    AddDefaultCharset utf-8
    AddCharset utf-8 .css .js .svg .xml
    DocumentRoot /srv/app/docroot
    ErrorDocument 400 /400.html
    ErrorDocument 401 /403.html
    ErrorDocument 403 /403.html
    ErrorDocument 404 /404.html
    ErrorDocument 500 /500.html
    FileETag None
    ErrorLog ${APACHE_LOG_DIR}/error.log
    LogFormat "(%h) %{X-Forwarded-For}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\" \"%{Accept-Encoding}i\"" custom
    CustomLog ${APACHE_LOG_DIR}/access.log custom

    <Directory "/srv/app/docroot">
        Require all granted
        AllowOverride None
    </Directory>

    <IfModule mod_rewrite.c>
        RewriteEngine on

        # Handle redirections of URLs with a traling slash.
        RewriteRule ^/p/(.*)/$ /p/$1 [R=301,L]
        RewriteRule ^/obra/(.*)/$ /obra/$1 [R=301,L]
        RewriteRule "^/credits/$" "/credits" [R=301,L]
        RewriteRule "^/instruccions/$" "/instruccions" [R=301,L]
        RewriteRule "^/llibres/$" "/llibres" [R=301,L]
        RewriteRule "^/projecte/$" "/projecte" [R=301,L]
        RewriteRule "^/top100/$" "/top100" [R=301,L]

        # Main pages.
        RewriteRule ^/p/(.*)$ /index.php?paremiotipus=$1 [B,L]
        RewriteRule ^/obra/(.*)$ /index.php?obra=$1 [B,L]
        RewriteRule "^/credits$" "/index.php?credits" [L]
        RewriteRule "^/instruccions$" "/index.php?instruccions" [L]
        RewriteRule "^/llibres$" "/index.php?llibres" [L]
        RewriteRule "^/projecte$" "/index.php?projecte" [L]
        RewriteRule "^/top100$" "/index.php?top100" [L]

        # Old pages.
        RewriteRule "^/top10000$" "/index.php?top10000" [L]
        RewriteRule "^/contacte$" "/" [R=302,QSD,L]
    </IfModule>

    <IfModule mod_headers.c>
        Header always set Cross-Origin-Opener-Policy "same-origin"
        Header always set Strict-Transport-Security "max-age=31536000"
        Header always set X-Content-Type-Options "nosniff"

        <FilesMatch "(?i)\.(avif|css|gif|ico|jpg|jpeg|js|mp3|png|svg|webp)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        <FilesMatch "(?i)\.(txt|xml)$">
            Header set Cache-Control "public, s-maxage=31536000"
        </FilesMatch>
    </IfModule>

    <IfModule mod_filter.c>
        <IfModule mod_brotli.c>
            AddOutputFilterByType BROTLI_COMPRESS application/javascript
            AddOutputFilterByType BROTLI_COMPRESS application/json
            AddOutputFilterByType BROTLI_COMPRESS application/ld+json
            AddOutputFilterByType BROTLI_COMPRESS application/manifest+json
            AddOutputFilterByType BROTLI_COMPRESS application/opensearchdescription+xml
            AddOutputFilterByType BROTLI_COMPRESS application/trafficadvice+json
            AddOutputFilterByType BROTLI_COMPRESS application/xml
            AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
            AddOutputFilterByType BROTLI_COMPRESS image/vnd.microsoft.icon
            AddOutputFilterByType BROTLI_COMPRESS image/x-icon
            AddOutputFilterByType BROTLI_COMPRESS text/css
            AddOutputFilterByType BROTLI_COMPRESS text/html
            AddOutputFilterByType BROTLI_COMPRESS text/javascript
            AddOutputFilterByType BROTLI_COMPRESS text/plain
            AddOutputFilterByType BROTLI_COMPRESS text/xml
        </IfModule>
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/json
            AddOutputFilterByType DEFLATE application/ld+json
            AddOutputFilterByType DEFLATE application/manifest+json
            AddOutputFilterByType DEFLATE application/opensearchdescription+xml
            AddOutputFilterByType DEFLATE application/trafficadvice+json
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE image/svg+xml
            AddOutputFilterByType DEFLATE image/vnd.microsoft.icon
            AddOutputFilterByType DEFLATE image/x-icon
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/javascript
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/xml
        </IfModule>
    </IfModule>

    <Files "opensearch.xml">
        Header set Content-Type "application/opensearchdescription+xml; charset=utf-8"
    </Files>

    <Location "/.well-known/traffic-advice">
        ForceType application/trafficadvice+json
    </Location>
</VirtualHost>
